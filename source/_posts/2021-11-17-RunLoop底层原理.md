---
layout:     post
title:      RunLoop底层原理
date:       2021/11/17
author:     HongWeiChen
header-img: img/blog-banner-dark.jpg
catalog: true
tags:
    - iOS
---

RunLoop是一个抽象的概念，指的是事件池，一个线程对应一个RunLoop，RunLoop主要的作用就是接收消息（例如：用户点击按钮，页面滚动），不需要处理消息的时候进行休眠（例如：进入App后台）。


# RunLoop底层分析



# RunLoop的概念

RunLoop实际上就是一个事件池，通常我们一个线程在执行结束后就会退出，而当我们需要一个线程需要随时能够处理消息或事件时，我们就需要一个RunLoop来保证线程不停的执行。

而实现RunLoop核心点在如何让RunLoop管理接收消息和事件，并且在没有消息或者事件时，进行休眠，等待接收消息时唤醒。

# RunLoop和线程之间的关系

RunLoop和线程是一一对应的关系，所有的RunLoop会存在与一个Dictionary中，thread是Dictionary的Key，是RunLoop对象则是Value，也就是RunLoop是通过线程取出得。我们没有办法显示的创建RunLoop，不论是NSRunLoop还是CFRunLoop，RunLoop的方法_CFRunLoopCreate()并没有对外部进行开放.

# RunLoop是在什么时候创建的

RunLoop是在线程产生交互后，系统会在内部获取RunLoop，当从Dictionary中获取不到RunLoop时，则会创建一个新的RunLoop，然后设置到Dictionary中。

# RunLoop有哪几种模式

- [default](#default)
- [connection](#connection)
- [modal](#modal)
- [event tracking](#event tracking)
- [common](#common)

# default

默认一般使用Default，Default几乎包含了除了Connection外所有的模式。

# connection

Connection一般是在处理NSConnection对象相关事件时使用，一般在系统内部使用。

# modal

处理模态视图事件使用

# event tracking

在拖动Loop或者其他User interface tracking loop时处于此模式下，此模式会限制输入事件的处理。

# common

这是一个伪模式，这个模式意味所有事件都可以处理。
