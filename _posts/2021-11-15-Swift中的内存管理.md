---
layout:     post
title:      Swift中的内存管理
subtitle:   Swift中的内存管理
date:       2021/11/12
author:     HongWeiChen
header-img: img/blog-banner-dark.jpg
catalog: true
tags:
    - Swift
---

# 前言

iOS在ARC时代下已经很久了，大多数情况下都不需要去关心内存的操作，但是还是有必要去了解一下的。

# weak/unowned

在Swift中，避免block循环引用主要就是使用weak/unowned。刚开始开发Swift的时候，一度无脑使用unowned来避免block循环引用的问题，直到从开发到提测时，测试反馈某个地方出现崩溃的问题，一番排查后发现unowned导致了野指针的崩溃问题。
为什么unowned会产生野指针呢？我们来看下unowned的定义

# unowned

- 不会产生强引用，实例销毁后仍然存储实例的内存地址
- 视图在实例销毁后访问无主引用，会产生运行错误

一下子就很明了了，因为unowned在实例销毁后仍然会存储实例的内存地址，这时候如果我们去访问unowned的对象，就会产生野指针，因为引用的实例对象已经被释放了。

# weak

- 实例销毁后，ARC会自动将弱引用设置为nil
- ARC自动给弱引用设置nil时，不会触发属性观察期

弱引用的情况下，则在实例销毁后，自动将weak对象设置为nil，并且不会触发set方法。所以如果我们要避免block循环引用时，还是要看情况使用weak还是unowned，那unowned在什么情况下使用呢？

>“Use a weak reference whenever it is valid for that reference to become nil at some point during its lifetime. Conversely, use an unowned reference when you know that the reference will never be nil once it has been set during initialization.”

在引用对象的生命周期内，如果它有可能为nil，那么就用weak引用。反之，当你知道引用对象初始化后永远不会为nil，就使用unowned。

所以，unowned的使用情况首先要根据当前实例实际情况来变更，如果block在当前视图销毁后仍然可能会去执行，unowned就不适合。

unowned也可以在全局单例、static变量情况下使用。那为什么还要区分weak与unowned呢？主要还是性能上的差别，weak在引用的对象实例被释放后，会将weak对象设置为nil，性能上自然会比unowned多做一步操作。

# 使用限制

不管是weak还是unowned都只能用于class实例，struct与enum是不存放于堆控件的，若在struct上使用weak或者unowned，编译器会直接报错，因为Swift是强安全类型的语言。

# Autorelease

```Swift
public func autoreleasepool<Result>(invoking body: () throws -> Result) rethrows -> Result
```

关于autorelease，参考了onevcat大神2015年发表的一篇文章

>Swift 在内存管理上使用的是自动引用计数 (ARC) 的一套方法，在 ARC 中虽然不需要手动地调用像是 retain，release 或者是 autorelease 这样的方法来管理引用计数，但是这些方法还是都会被调用的 -- 只不过是编译器在编译时在合适的地方帮我们加入了而已。其中 retain 和 release 都很直接，就是将对象的引用计数加一或者减一。但是autorelease 就比较特殊一些，它会将接受该消息的对象放到一个预先建立的自动释放池 (auto release pool) 中，并在 自动释放池收到 drain 消息时将这些对象的引用计数减一，然后将它们从池子中移除 (这一过程形象地称为“抽干池子”)。
在 app 中，整个主线程其实是跑在一个自动释放池里的，并且在每个主 Runloop 结束时进行 drain 操作。这是一种必要的延迟释放的方式，因为我们有时候需要确保在方法内部初始化的生成的对象在被返回后别人还能使用，而不是立即被释放掉。




# 参考
- [autoreleasepool](https://swifter.tips/autoreleasepool/)
- [内存管理](https://www.jianshu.com/p/0d3b7b1b2495)
- [什么时候该用 unowned](https://www.jianshu.com/p/80aa703b6ffc)
