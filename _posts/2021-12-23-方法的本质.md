---
layout:     post
title:      方法的本质
subtitle:   IMP、SEL、底层原理、转发流程
date:       2021/12/22
author:     HongWeiChen
header-img: img/blog-banner-dark.jpg
catalog: true
tags:
    - 原创
---


# 方法的本质是什么

方法的本质是消息，底层使用objc_msgSend，objc_msgSend有两个参数，方法接受者和方法的主体。当我们调用一个方法时，objc_msgSend会先从cacht_t缓存列表中查找到对应的bucket，然后从bucket中取到sel和imp，sel是方法编号，imp是函数指针地址，从缓存中获取对应的bucket是汇编层面的快速查找。若快速查找找不到对应的方法，则开始执行慢速查找，也就是遍历查找，遍历自身的方法列表method_list，若找不到再去父类寻找，最终一直到NSObject若一直都找不到的话，因为iOS有多态的特性，还会从分类中的方法开始查找。还是没有找到对应的方法就只能进入消息转发的方法中，消息转发也分为快速转发和慢速转发，forwardingTargetForSelector和methodSignatureForSelector，这两个方法顺序执行，如果还是没有发现可以补救的方法就会出现崩溃异常程序退出。

# 避免方法转发失败产生崩溃的方法

```
+ (BOOL)resolveInstanceMethod:(SEL)sel {
    Method method = class_getInstanceMethod(self, @selector(catchException));
    IMP imp = method_getImplementation(method);
    const char *type = method_getTypeEncoding(method);
    bool isSuccess = class_addMethod(self, sel, imp, type);
    return isSuccess;
}
```

在resolveInstanceMethod中编写补救方法，抓取崩溃信息并且上传到服务器后台。也可以在forwardingTargetForSelector中编写，只是forwardingTargetForSelector转发的对象一定需要含有aSelector的方法，所以不建议使用。

**缓存列表结构：bucket -> {imp, sel} = cache_t[key]**
