---
layout:     post
title:      iOS内存管理
subtitle:   iOS内存管理
date:       2021/11/15
author:     HongWeiChen
header-img: img/blog-banner-dark.jpg
catalog: true
tags:
    - iOS
---

iOS中内存管理的属性修饰符分别有
- retain
- strong
- weak
- assign
- unsafe_unretained
- unowned

其中unowned是Swift中的无主引用，其作用和assign、unsafe_unretained相似。

其作用是引用对象指针，不会进行引用计数（retainCount）自增的处理，但是在引用对象被释放之后，其对象指针仍然指向引用对象指针，导致野指针的问题。

retain是MRC时代下的产物，在ARC下已经不推荐使用retain作为内存修饰符，被retain修饰的对象在使用self进行调用的时候，会调用retain的动作，从而导致引用计数（retainCount）增加。


strong是在ARC后产生的一个内存管理修饰符，其底层代码如下（参考objc4-818.2）

```C
void
objc_storeStrong(id *location, id obj)
{
    id prev = *location;
    if (obj == prev) {
        return;
    }
    objc_retain(obj);
    *location = obj;
    objc_release(prev);
}
```

retain新对象，重新赋值并且release旧对象。没有什么太复杂的调用，而objc_retain和objc_release底层的实现不在这次的了解范围内，下次说明。

weak的实现可以翻看我之前写的[iOS中weak的底层原理](https://hongweichen.github.io/2021/11/15/iOS中weak的底层原理/)

这里简要说一下weak和assign、unsafe_unretained、unowned的区别，之前提到了assign、unsafe_unretained、unowned在引用对象被释放了之后，仍然保存对象指针的地址，从而导致野指针，而weak在引用对象被释放了之后，会自动设置为nil，其底层调用代码如下（参考源码objc4-818.2）

```
// rdar://20206767
// return uintptr_t instead of bool so that the various raw-isa
// -release paths all return zero in eax
uintptr_t
objc_object::sidetable_release(bool locked, bool performDealloc)
{
#if SUPPORT_NONPOINTER_ISA
    ASSERT(!isa.nonpointer);
#endif
    SideTable& table = SideTables()[this];

    bool do_dealloc = false;

    if (!locked) table.lock();
    auto it = table.refcnts.try_emplace(this, SIDE_TABLE_DEALLOCATING);
    auto &refcnt = it.first->second;
    if (it.second) {
        do_dealloc = true;
    } else if (refcnt < SIDE_TABLE_DEALLOCATING) {
        // SIDE_TABLE_WEAKLY_REFERENCED may be set. Don't change it.
        do_dealloc = true;
        refcnt |= SIDE_TABLE_DEALLOCATING;
    } else if (! (refcnt & SIDE_TABLE_RC_PINNED)) {
        refcnt -= SIDE_TABLE_RC_ONE;
    }
    table.unlock();
    if (do_dealloc  &&  performDealloc) {
        ((void(*)(objc_object *, SEL))objc_msgSend)(this, @selector(dealloc));
    }
    return do_dealloc;
}
```
